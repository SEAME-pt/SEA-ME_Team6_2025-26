name: OTA Build & Release (Multi-Platform)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.3)'
        required: true
        default: 'v1.0.3'
      platform:
        description: 'Target platform (rpi4, rpi5, or both)'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - rpi4
          - rpi5

permissions:
  contents: write

env:
  # Docker images for each platform
  SDK_IMAGE_RPI4: souzitaaaa/team6-agl-sdk:latest
  SDK_IMAGE_RPI5: souzitaaaa/team6-r5-agl-sdk:latest
  # Fallback to latest if specific tags don't exist yet
  SDK_IMAGE_FALLBACK: souzitaaaa/team6-agl-sdk:latest

jobs:
  # ============================================================
  # RPi5 Build (64-bit) - KUKSA Publisher
  # ============================================================
  build-kuksa-rpi5:
    name: Build KUKSA (RPi5 - 64-bit)
    runs-on: ubuntu-22.04
    if: ${{ github.event.inputs.platform != 'rpi4' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull RPi5 SDK (64-bit)
        run: |
          docker pull ${{ env.SDK_IMAGE_RPI5 }} || docker pull ${{ env.SDK_IMAGE_FALLBACK }}

      - name: Build KUKSA publisher (aarch64)
        run: |
          # Use rpi5 image, fallback to latest
          IMAGE=${{ env.SDK_IMAGE_RPI5 }}
          docker image inspect $IMAGE > /dev/null 2>&1 || IMAGE=${{ env.SDK_IMAGE_FALLBACK }}
          
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            $IMAGE \
            bash -c '
              set -e
              
              echo "=== Building KUKSA for RPi5 (aarch64) ==="
              echo "SDK Environment:"
              
              # Source the SDK environment
              if [ -f /opt/agl-sdk/environment-setup-aarch64-agl-linux ]; then
                echo "Using aarch64 SDK"
                source /opt/agl-sdk/environment-setup-aarch64-agl-linux
              elif [ -f /opt/agl-sdk/environment-setup-* ]; then
                echo "Using available SDK"
                source /opt/agl-sdk/environment-setup-*
              fi
              
              echo "CC=$CC"
              echo "CXX=$CXX"
              
              cd /workspace/src/kuksa/kuksa_RPi5
              
              make clean || true
              make
              
              echo "=== Verifying binary architecture ==="
              file bin/can_to_kuksa_publisher
              file bin/can_to_kuksa_publisher | grep -q "64-bit\|aarch64" && echo "‚úÖ Binary is 64-bit" || echo "‚ö†Ô∏è Binary may not be 64-bit"
            '

      - name: Upload KUKSA artifact (RPi5)
        uses: actions/upload-artifact@v4
        with:
          name: kuksa-rpi5
          path: |
            src/kuksa/kuksa_RPi5/bin/can_to_kuksa_publisher
            src/kuksa/kuksa_RPi5/vss_min.json

  # ============================================================
  # RPi4 Build (32-bit) - Qt Cluster
  # ============================================================
  build-cluster-rpi4:
    name: Build Cluster (RPi4 - 32-bit)
    runs-on: ubuntu-22.04
    if: ${{ github.event.inputs.platform != 'rpi5' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull RPi4 SDK (32-bit)
        run: |
          docker pull ${{ env.SDK_IMAGE_RPI4 }} || docker pull ${{ env.SDK_IMAGE_FALLBACK }}

      - name: Build Qt Cluster (armv7)
        run: |
          # Use rpi4 image, fallback to latest
          IMAGE=${{ env.SDK_IMAGE_RPI4 }}
          docker image inspect $IMAGE > /dev/null 2>&1 || IMAGE=${{ env.SDK_IMAGE_FALLBACK }}
          
          docker run --rm \
            -v ${{ github.workspace }}/src:/workspace \
            $IMAGE \
            bash -c '
              set -e
              
              echo "=== Building Qt Cluster for RPi4 (armv7) ==="
              
              # Source the SDK environment
              if [ -f /opt/agl-sdk/environment-setup-armv7vet2hf-neon-vfpv4-agl-linux-gnueabi ]; then
                echo "Using armv7 SDK"
                source /opt/agl-sdk/environment-setup-armv7vet2hf-neon-vfpv4-agl-linux-gnueabi
              elif [ -f /opt/agl-sdk/environment-setup-* ]; then
                echo "Using available SDK"
                source /opt/agl-sdk/environment-setup-*
              fi
              
              qt6-build.sh /workspace/cluster/
              
              echo "=== Verifying binary architecture ==="
              file /workspace/cluster/build-arm/HelloQt6Qml
              file /workspace/cluster/build-arm/HelloQt6Qml | grep -q "32-bit\|ARM" && echo "‚úÖ Binary is 32-bit ARM" || echo "‚ö†Ô∏è Check binary architecture"
            '

      - name: Upload Cluster artifact (RPi4)
        uses: actions/upload-artifact@v4
        with:
          name: cluster-rpi4
          path: src/cluster/build-arm/HelloQt6Qml

  # ============================================================
  # Release - Create separate packages for each platform
  # ============================================================
  release:
    name: Create OTA Releases
    needs: [build-kuksa-rpi5, build-cluster-rpi4]
    if: always() && (needs.build-kuksa-rpi5.result == 'success' || needs.build-cluster-rpi4.result == 'success')
    runs-on: ubuntu-22.04
    
    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      # --- RPi5 Package ---
      - name: Download KUKSA artifact (RPi5)
        if: needs.build-kuksa-rpi5.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: kuksa-rpi5
          path: ota-rpi5/kuksa

      - name: Package OTA for RPi5
        if: needs.build-kuksa-rpi5.result == 'success'
        run: |
          echo "=== RPi5 OTA Package Contents ==="
          find ota-rpi5 -type f
          tar -czf update-rpi5.tar.gz -C ota-rpi5 .
          sha256sum update-rpi5.tar.gz > hash-rpi5.txt

      # --- RPi4 Package ---
      - name: Download Cluster artifact (RPi4)
        if: needs.build-cluster-rpi4.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: cluster-rpi4
          path: ota-rpi4/cluster

      - name: Package OTA for RPi4
        if: needs.build-cluster-rpi4.result == 'success'
        run: |
          echo "=== RPi4 OTA Package Contents ==="
          find ota-rpi4 -type f
          tar -czf update-rpi4.tar.gz -C ota-rpi4 .
          sha256sum update-rpi4.tar.gz > hash-rpi4.txt

      # --- Combined Package (legacy support) ---
      - name: Create combined package
        run: |
          mkdir -p ota-combined
          [ -d ota-rpi4 ] && cp -r ota-rpi4/* ota-combined/ || true
          [ -d ota-rpi5 ] && cp -r ota-rpi5/* ota-combined/ || true
          
          echo "=== Combined OTA Package Contents ==="
          find ota-combined -type f
          tar -czf update.tar.gz -C ota-combined .
          sha256sum update.tar.gz > hash.txt

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "OTA Release ${{ steps.version.outputs.version }}"
          body: |
            ## OTA Update Package (Multi-Platform)
            
            ### üì¶ Available Packages
            
            | Package | Platform | Architecture | Contents |
            |---------|----------|--------------|----------|
            | `update-rpi4.tar.gz` | Raspberry Pi 4 | ARM 32-bit (armv7) | Qt6 Cluster |
            | `update-rpi5.tar.gz` | Raspberry Pi 5 (AGL) | ARM 64-bit (aarch64) | KUKSA Publisher |
            | `update.tar.gz` | Combined | Both | All binaries |
            
            ### üéØ Target Paths
            
            | Binary | Device | Target Path |
            |--------|--------|-------------|
            | `HelloQt6Qml` | RPi4 | `/opt/cluster/` |
            | `can_to_kuksa_publisher` | RPi5 | `/home/kuksa_RPi5/bin/` |
            | `vss_min.json` | RPi5 | `/home/kuksa_RPi5/` |
            
            ### üì• Installation
            
            **On RPi4:**
            ```bash
            /opt/ota/ota-update.sh ${{ steps.version.outputs.version }}
            ```
            
            **On RPi5 (AGL):**
            ```bash
            /opt/ota/ota-update.sh ${{ steps.version.outputs.version }}
            ```
            
            ### ‚ö†Ô∏è Architecture Notes
            - RPi4 binaries are **32-bit ARM** (armv7)
            - RPi5 binaries are **64-bit ARM** (aarch64)
            - Do not install wrong architecture on wrong device!
          files: |
            update.tar.gz
            hash.txt
            update-rpi4.tar.gz
            hash-rpi4.txt
            update-rpi5.tar.gz
            hash-rpi5.txt
