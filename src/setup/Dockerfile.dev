# ===========================================================================
# Dockerfile.dev - Development environment extending base image
# ===========================================================================
# Usage: 
#   docker build -f Dockerfile.dev -t cluster-dev:latest .
#   docker run -it --rm -v $(pwd)/cluster:/workspace cluster-dev:latest
# ===========================================================================

FROM souzitaaaa/team6-base:bookworm

ARG QT_VERSION=6.7.3
ARG PROTOBUF_TAG=v25.0
ARG GRPC_TAG=v1.60.1
ARG ABSEIL_TAG=20230802.0

# Install additional development tools and X11 libraries for native Qt development
RUN apt-get update && apt-get install -y \
    libgl1 libxcb-xinerama0 libxcb-cursor0 \
    libxcb-util1 libxcb-render-util0 \
    libxcb-randr0-dev libxcb-xtest0-dev libxcb-xinerama0-dev \
    libxcb-shape0-dev libxcb-xkb-dev libxcb-render0-dev \
    libxcb-cursor-dev libxcb-icccm4-dev libxcb-sync-dev \
    libc-ares-dev \
    gdb valgrind clang-format \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# ===========================================================================
# Build Abseil from source (required for Protobuf v25.0)
# ===========================================================================
RUN echo "=== Building Abseil ${ABSEIL_TAG} ===" && \
    git clone --depth 1 --branch ${ABSEIL_TAG} https://github.com/abseil/abseil-cpp.git /tmp/abseil && \
    cmake -S /tmp/abseil -B /tmp/abseil/build \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
        -DABSL_BUILD_TESTING=OFF \
        -DABSL_USE_GOOGLETEST_HEAD=OFF \
        -DCMAKE_INSTALL_PREFIX=/usr/local && \
    cmake --build /tmp/abseil/build -j$(nproc) && \
    cmake --install /tmp/abseil/build && \
    ldconfig && \
    rm -rf /tmp/abseil

# ===========================================================================
# Build Protobuf v25.0 from source (matching cross-compilation version)
# ===========================================================================
RUN echo "=== Building Protobuf ${PROTOBUF_TAG} ===" && \
    git clone --depth 1 --branch ${PROTOBUF_TAG} https://github.com/protocolbuffers/protobuf.git /tmp/protobuf && \
    cmake -S /tmp/protobuf -B /tmp/protobuf/build \
        -DCMAKE_BUILD_TYPE=Release \
        -Dprotobuf_BUILD_TESTS=OFF \
        -Dprotobuf_ABSL_PROVIDER=package \
        -DCMAKE_INSTALL_PREFIX=/usr/local && \
    cmake --build /tmp/protobuf/build -j$(nproc) && \
    cmake --install /tmp/protobuf/build && \
    ldconfig && \
    rm -rf /tmp/protobuf

# ===========================================================================
# Build gRPC v1.60.1 from source (matching cross-compilation version)
# ===========================================================================
RUN echo "=== Building gRPC ${GRPC_TAG} ===" && \
    git clone --depth 1 --branch ${GRPC_TAG} https://github.com/grpc/grpc.git /tmp/grpc && \
    cd /tmp/grpc && \
    git submodule update --init --recursive && \
    cmake -S /tmp/grpc -B /tmp/grpc/build \
        -DCMAKE_BUILD_TYPE=Release \
        -DgRPC_INSTALL=ON \
        -DgRPC_BUILD_TESTS=OFF \
        -DgRPC_PROTOBUF_PROVIDER=package \
        -DgRPC_ABSL_PROVIDER=package \
        -DgRPC_CARES_PROVIDER=package \
        -DgRPC_RE2_PROVIDER=package \
        -DgRPC_SSL_PROVIDER=package \
        -DgRPC_ZLIB_PROVIDER=package \
        -DCMAKE_INSTALL_PREFIX=/usr/local && \
    cmake --build /tmp/grpc/build -j$(nproc) && \
    cmake --install /tmp/grpc/build && \
    ldconfig && \
    rm -rf /tmp/grpc

# Verify installations
RUN echo "=== Verifying Protobuf/gRPC installation ===" && \
    protoc --version && \
    which grpc_cpp_plugin && \
    ldconfig -p | grep -E "(protobuf|grpc|absl)" | head -20

# ===========================================================================
# Build Qt6 6.7.3 for native x86_64 development
# ===========================================================================
RUN mkdir -p qt6/src qt6/host-build && \
    cd qt6/src && \
    echo "=== Downloading Qt 6.7.3 submodules ===" && \
    wget https://download.qt.io/archive/qt/6.7/${QT_VERSION}/submodules/qtbase-everywhere-src-${QT_VERSION}.tar.xz && \
    wget https://download.qt.io/archive/qt/6.7/${QT_VERSION}/submodules/qtshadertools-everywhere-src-${QT_VERSION}.tar.xz && \
    wget https://download.qt.io/archive/qt/6.7/${QT_VERSION}/submodules/qtdeclarative-everywhere-src-${QT_VERSION}.tar.xz && \
    wget https://download.qt.io/archive/qt/6.7/${QT_VERSION}/submodules/qtsvg-everywhere-src-${QT_VERSION}.tar.xz && \
    \
    echo "=== Extracting sources ===" && \
    cd ../host-build && \
    tar xf ../src/qtbase-everywhere-src-${QT_VERSION}.tar.xz && \
    tar xf ../src/qtshadertools-everywhere-src-${QT_VERSION}.tar.xz && \
    tar xf ../src/qtdeclarative-everywhere-src-${QT_VERSION}.tar.xz && \
    tar xf ../src/qtsvg-everywhere-src-${QT_VERSION}.tar.xz && \
    \
    echo "=== Building qtbase ===" && \
    cd qtbase-everywhere-src-${QT_VERSION} && \
    cmake -GNinja \
        -DCMAKE_BUILD_TYPE=Release \
        -DQT_BUILD_EXAMPLES=OFF \
        -DQT_BUILD_TESTS=OFF \
        -DCMAKE_INSTALL_PREFIX=/opt/qt6 \
        -DFEATURE_xcb=ON \
        -DFEATURE_dbus=ON && \
    cmake --build . --parallel $(nproc) && \
    cmake --install . && \
    \
    echo "=== Building qtshadertools ===" && \
    cd ../qtshadertools-everywhere-src-${QT_VERSION} && \
    /opt/qt6/bin/qt-configure-module . && \
    cmake --build . --parallel $(nproc) && \
    cmake --install . && \
    \
    echo "=== Building qtdeclarative (QML + Quick + Controls2) ===" && \
    cd ../qtdeclarative-everywhere-src-${QT_VERSION} && \
    /opt/qt6/bin/qt-configure-module . && \
    cmake --build . --parallel $(nproc) && \
    cmake --install . && \
    \
    echo "=== Building qtsvg ===" && \
    cd ../qtsvg-everywhere-src-${QT_VERSION} && \
    /opt/qt6/bin/qt-configure-module . && \
    cmake --build . --parallel $(nproc) && \
    cmake --install . && \
    \
    echo "=== Cleanup ===" && \
    cd /build && \
    rm -rf qt6

# Verify Qt installation
RUN echo "=== Verifying Qt6 installation ===" && \
    /opt/qt6/bin/qmake --version && \
    ls -la /opt/qt6/lib/cmake/ | grep Qt6 | head -10

# ===========================================================================
# Environment Configuration
# ===========================================================================
ENV PATH="/opt/qt6/bin:${PATH}"
ENV LD_LIBRARY_PATH="/opt/qt6/lib:${LD_LIBRARY_PATH}"
ENV PKG_CONFIG_PATH="/opt/qt6/lib/pkgconfig:${PKG_CONFIG_PATH}"
ENV CMAKE_PREFIX_PATH="/opt/qt6:${CMAKE_PREFIX_PATH}"
ENV QT_PLUGIN_PATH="/opt/qt6/plugins"
ENV QML_IMPORT_PATH="/opt/qt6/qml"

WORKDIR /workspace

RUN mkdir /etc/kuksa

RUN mkdir /etc/kuksa/tls
RUN mkdir /etc/kuksa/jwt

COPY ca.crt /etc/kuksa/tls
COPY reader.jwt /etc/kuksa/jwt

# For X11 forwarding if needed
ENV DISPLAY=:0

CMD ["/bin/bash"]