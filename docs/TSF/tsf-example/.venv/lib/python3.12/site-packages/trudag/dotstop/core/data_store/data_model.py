from schema import Schema, Use, Or, SchemaError
from collections import Counter
from trudag.dotstop.core.exception import DataModelError

_DATA_SCHEMA = Schema(
    [
        {
            "scores": [{"id": str, "score": Use(float)}],
            "info": {
                "Repository root": str,
                "Commit SHA": Or(str, None),
                "Commit date/time": Use(int),
                "Commit tag": Or(str, None),
                "CI job id": Or(str, None),
                "Branch name": Or(str, None),
                "Schema version": str,
            },
        }
    ],
    ignore_extra_keys=True,
)


def validate_data(data: list[dict]):
    try:
        _DATA_SCHEMA.validate(data)
        for entry in data:
            ids = [dp["id"] for dp in entry["scores"]]
            duplicate_ids = [id_ for id_, count in Counter(ids).items() if count > 1]
            if duplicate_ids:
                raise DataModelError(
                    f"the following ids are not unique {duplicate_ids}"
                )
    except (SchemaError, DataModelError) as exception:
        msg = f"invalid data recieved from data store {exception}"
        raise DataModelError(msg) from exception
