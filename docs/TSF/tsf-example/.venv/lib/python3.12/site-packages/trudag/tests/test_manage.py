import logging
import copy
from trudag import manage, dotstop, utils
from trudag.dotstop.core.graph.trustable_graph import LinkStatus
from trudag.error import ExitCodes
from trudag.dotstop.tests import FakeItem
from trudag.dotstop.core.graph import TrustableGraph
from colorama import Fore, Style
from pathlib import Path
import json
import pytest
import git

EXAMPLE_UNREVIEWED_ITEMS = ["ITEM_1", "ITEM_2", "ITEM_3", "ITEM_4", "ITEM_5"]
EXAMPLE_UNREVIEWED_LINKS = [["ITEM_1", "ITEM_2"], ["ITEM_3", "ITEM_4"]]

EXAMPLE_LINT_REPORT = {
    "unreviewed_items": EXAMPLE_UNREVIEWED_ITEMS,
    "suspect_links": [
        {"parent": link[0], "child": link[1]} for link in EXAMPLE_UNREVIEWED_LINKS
    ],
}


def test_manage_lint_compare_ok(example_graph: TrustableGraph):
    _, unreviewed_items, suspect_links = manage._lint(example_graph, None)  # noqa SLF001

    exit_code = manage._compare_lint_outputs(  # noqa SLF001
        unreviewed_items, suspect_links, unreviewed_items, suspect_links
    )
    assert exit_code == ExitCodes.SUCCESS


def test_graph_items_diff_ok(example_graph: TrustableGraph):
    changed_items, changed_items_with_sme_scores = manage._get_changed_items(  # noqa SLF001
        example_graph, example_graph
    )
    assert changed_items == []
    assert changed_items_with_sme_scores == {}


def test_manage_set_item_links(example_graph: TrustableGraph):
    for link_status, item_status in [
        (LinkStatus.LINKED, True),
        (LinkStatus.SUSPECT, False),
    ]:
        # Set ASN-2 (mocks the set-item)
        example_graph.set_review_status("ASN-2", item_status)

        # Set all links function
        manage.set_all_link_status(example_graph, "ASN-2", link_status)

        # All links between ASN-2 and reviewed items should be LINKED
        assert example_graph.get_link_status("ASN-2", "DOC-1") == link_status

        # All links between ASN-2 and non-reviewed items should be unchanged
        assert example_graph.get_link_status("ASN-2", "TST-3") == LinkStatus.SUSPECT
        assert example_graph.get_link_status("EXP-1", "ASN-2") == LinkStatus.SUSPECT


def test_manage_lint_diff_warning(caplog, example_graph: TrustableGraph):
    _, unreviewed_items, suspect_links = manage._lint(example_graph, None)  # noqa SLF001

    modified_graph = copy.deepcopy(example_graph)
    modified_graph.add_items(
        [FakeItem({"name": "NEW_ITEM", "text": "EXAMPLE NEW ITEM", "score": 0.5})]
    )

    # Create a new unreviewed item
    modified_graph.set_review_status("ASN-1", False)
    expected_new_unreviewed_item = "ASN-1"

    # Remove item
    #   - removes unreviewed item
    #   - removes suspect link
    modified_graph.remove_item("EXP-1")
    expected_removed_unreviewed_item = "EXP-1"
    expected_removed_suspect_links = "EXP-1 -> ASN-2"

    # Modify item
    modified_graph.get_item("ASN-CONTEXT").obj_dict["text"] = "NEW TEXT"
    # Delete cached sha.
    del modified_graph.get_item("ASN-CONTEXT").sha
    modified_graph.set_review_status("ASN-CONTEXT", True)

    # Create new suspect link
    modified_graph.set_link_status("ASN-1", "DOC-1", dotstop.LinkStatus.SUSPECT)
    expected_new_suspect_link = "ASN-1 -> DOC-1"

    _, modified_unreviewed_items, modified_suspect_links = manage._lint(  # noqa SLF001
        modified_graph, None
    )

    exit_code = manage._compare_lint_outputs(  # noqa SLF001
        modified_unreviewed_items,
        modified_suspect_links,
        unreviewed_items,
        suspect_links,
    )
    assert exit_code == ExitCodes.LINT_FAILURE

    warning_msgs = [
        f"Unreviewed items added:\n\n{Fore.GREEN}  {expected_new_unreviewed_item}{Style.RESET_ALL}\n",
        f"Unreviewed items removed:\n\n{Fore.RED}  {expected_removed_unreviewed_item}{Style.RESET_ALL}\n",
        f"Suspect links added:\n\n{Fore.GREEN}  {expected_new_suspect_link}{Style.RESET_ALL}\n",
        f"Suspect links removed:\n\n{Fore.RED}  {expected_removed_suspect_links}{Style.RESET_ALL}\n",
    ]

    for warning_msg in warning_msgs:
        assert (
            "trudag.manage",
            logging.WARNING,
            warning_msg,
        ) in caplog.record_tuples

    changed_items, changed_items_with_sme_scores = manage._get_changed_items(  # noqa SLF001
        example_graph, modified_graph
    )

    assert sorted(changed_items) == sorted(["ASN-1", "ASN-CONTEXT"])
    assert changed_items_with_sme_scores == {"ASN-CONTEXT": {"SME Engineer": 0.5}}


def test_manage_diff_lint_okay(tmp_path):
    lint_report_path_1 = Path(tmp_path, "lint_file_1")
    lint_report_path_2 = Path(tmp_path, "lint_file_2")

    lint_report_path_1.write_text(json.dumps(EXAMPLE_LINT_REPORT))
    lint_report_path_2.write_text(json.dumps(EXAMPLE_LINT_REPORT))

    exit_code = manage.diff_lint_report(lint_report_path_1, lint_report_path_2)

    assert exit_code == ExitCodes.SUCCESS


def test_manage_diff_lint_bad_report(tmp_path):
    lint_report_path_1 = Path(tmp_path, "lint_file_1")
    lint_report_path_2 = Path(tmp_path, "lint_file_2")

    lint_report_path_1.write_text(json.dumps(EXAMPLE_LINT_REPORT))
    lint_report_path_2.write_text(json.dumps(""))
    # Don't write to path_2 to see how diff_lint_report handles a bad report

    with pytest.raises(
        TypeError, match=rf".*Unable to parse lint report ({lint_report_path_2})*"
    ):
        manage.diff_lint_report(lint_report_path_1, lint_report_path_2)


def test_manage_diff_lint_changes(caplog, tmp_path):
    lint_report_path_1 = Path(tmp_path, "lint_file_1")
    lint_report_path_2 = Path(tmp_path, "lint_file_2")

    lint_report_path_1.write_text(json.dumps(EXAMPLE_LINT_REPORT))

    modified_lint_report = EXAMPLE_LINT_REPORT
    modified_lint_report["unreviewed_items"] = EXAMPLE_UNREVIEWED_ITEMS[0:2]
    lint_report_path_2.write_text(json.dumps(modified_lint_report))

    exit_code = manage.diff_lint_report(lint_report_path_1, lint_report_path_2)

    assert exit_code == ExitCodes.LINT_FAILURE

    removed_unreviewed_items = "\n".join(
        [f"  {item}" for item in EXAMPLE_UNREVIEWED_ITEMS[2:]]
    )

    assert (
        "trudag.manage",
        logging.WARNING,
        f"Unreviewed items removed:\n\n{Fore.RED}{removed_unreviewed_items}{Style.RESET_ALL}\n",
    ) in caplog.record_tuples


def test_diff_graph_changes(
    tmp_path, monkeypatch, caplog, example_graph: TrustableGraph
):
    expected_stdout = []

    modified_graph = copy.deepcopy(example_graph)

    monkeypatch.chdir(tmp_path)
    repo = git.Repo.init(tmp_path)

    CONTENT_STR = "SOME ITEM CONTENT"
    CONTENT_CHANGE_STR = (
        f"{utils.OUTPUT_SEPARATOR}\n{CONTENT_STR}\n{utils.OUTPUT_SEPARATOR}"
    )

    Path(tmp_path, "ASN-2.md").write_text(CONTENT_STR)
    Path(tmp_path, "ASN-CONTEXT.json").write_text(CONTENT_STR)

    # Set-up graph and item files
    example_graph.to_file(tmp_path / utils.DOTSTOP_DEFAULT_FILENAME)
    repo.index.add(utils.DOTSTOP_DEFAULT_FILENAME)
    repo.index.commit("init")

    # Change some items
    modified_graph.set_review_status("ASN-2", True)
    modified_graph.set_review_status("ASN-CONTEXT", False)
    modified_graph.remove_item("ASN-1")
    modified_graph.to_file(tmp_path / utils.DOTSTOP_DEFAULT_FILENAME)
    repo.index.add(utils.DOTSTOP_DEFAULT_FILENAME)
    repo.index.commit("changes")

    exit_code = manage.diff_graph_git(modified_graph, "HEAD~")

    expected_stdout.append(
        (
            "trudag.manage",
            logging.WARNING,
            f"Items removed from graph:\n\n{Fore.RED}  ASN-1{Style.RESET_ALL}\n",
        )
    )
    expected_stdout.append(
        (
            "trudag.manage",
            logging.WARNING,
            f"Item ASN-CONTEXT has changed and contains the following SME scores:\n\n{Fore.GREEN}  SME Engineer: 0.5{Style.RESET_ALL}\n",
        )
    )
    expected_stdout.append(
        (
            "trudag.manage",
            logging.WARNING,
            f"Item has changed ASN-2:\n{CONTENT_CHANGE_STR}\n",
        )
    )
    expected_stdout.append(
        (
            "trudag.manage",
            logging.WARNING,
            f"Item has changed ASN-CONTEXT:\n{CONTENT_CHANGE_STR}\n",
        )
    )

    assert exit_code == ExitCodes.SME_ITEM_CHANGE_DETECTED

    for stdout in expected_stdout:
        assert stdout in caplog.record_tuples

    expected_stdout = []

    repo.index.commit("revert changes")

    example_graph.to_file(tmp_path / utils.DOTSTOP_DEFAULT_FILENAME)

    exit_code = manage.diff_graph_git(example_graph, "HEAD~")

    expected_stdout.append(
        (
            "trudag.manage",
            logging.WARNING,
            f"Items added to graph:\n\n{Fore.GREEN}  ASN-1{Style.RESET_ALL}\n",
        )
    )
    expected_stdout.append(
        (
            "trudag.manage",
            logging.WARNING,
            f"Item ASN-CONTEXT has changed and contains the following SME scores:\n\n{Fore.GREEN}  SME Engineer: 0.5{Style.RESET_ALL}\n",
        )
    )
    expected_stdout.append(
        (
            "trudag.manage",
            logging.WARNING,
            f"Item has changed ASN-2:\n{CONTENT_CHANGE_STR}\n",
        )
    )
    expected_stdout.append(
        (
            "trudag.manage",
            logging.WARNING,
            f"Item has changed ASN-CONTEXT:\n{CONTENT_CHANGE_STR}\n",
        )
    )

    for stdout in expected_stdout:
        assert stdout in caplog.record_tuples

    assert exit_code == ExitCodes.SME_ITEM_CHANGE_DETECTED
