# ******************************************************************************
# * Copyright (c) 2024-5 Codethink
# *
# * This program and the accompanying materials are made available under the
# * terms of the Eclipse Public License 2.0 which is available at
# * http://www.eclipse.org/legal/epl-2.0.
# *
# * This Source Code may also be made available under the following Secondary
# * Licenses when the conditions for such availability set forth in the Eclipse
# * Public License, v. 2.0 are satisfied: GNU General Public License, version 2
# * with the GNU Classpath Exception which is
# * available at https://www.gnu.org/software/classpath/license.html.
# *
# * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0
# ******************************************************************************

"""
The `trudag` CLI frontend.
"""

import logging
import importlib.metadata
import os
import sys
import click
import doorstop

from pathlib import Path
from schema import SchemaError
from yaml import YAMLError

import trudag.publish
import trudag.plot
import trudag.score
import trudag.manage
import frontends.cli.utils as cli_utils
import trudag.utils as utils
from trudag.dotstop import (
    GraphStructureError,
    GraphActionError,
    ItemError,
    LinkStatus,
    DotstopError,
    DataModelError,
    PluginError,
    GitError,
    VersionError,
    ArtifactError,
)
from trudag.dotstop.core.graph import build_trustable_graph
from trudag.dotstop.core.constants import IGNORE_FILE
from trudag.dotstop.core.artifact import Artifact

handler = logging.StreamHandler()
handler.setFormatter(logging.Formatter("%(levelname)s: %(message)s"))

# Use the `trudag` package logger, so that all configuration here is inherited.
logger = logging.getLogger("trudag")
logger.setLevel(logging.INFO)
logger.addHandler(handler)

# Define some reusable options that do not belong to a single group.
validate_option = click.option(
    "--validate/--no-validate",
    default=True,
    type=bool,
    is_flag=True,
    help="Run automated validators when scoring.",
)
fail_on_error_option = click.option(
    "--fail-on-error/--no-fail-on-error",
    default=False,
    type=bool,
    is_flag=True,
    help="fail with exit code on errors during the command run.",
)

dump_option = click.option(
    "--dump",
    "-d",
    type=Path,
    help="Output file path for the Trustable Scores file, currently supports .csv and .json file extensions or a configured data store",
)
artifact_option = click.option(
    "--artifact",
    required=True,
    type=click.Path(path_type=Path, file_okay=True, dir_okay=False),
    help="File path to read/write artifact to/from.",
)


@click.group(name="trudag", invoke_without_command=True)
@click.version_option(importlib.metadata.version("trustable"))
@click.option(
    "--dot / --door",
    default=True,
    type=bool,
    is_flag=True,
    help="Use dotstop backend, not doorstop.",
    show_default=True,
)
@click.option(
    "--verbose",
    default=False,
    type=bool,
    is_flag=True,
    help="Enable verbose logging.",
)
@click.option(
    "--init",
    default=False,
    type=bool,
    is_flag=True,
    help="Initialize an empty dot database.",
)
@click.option(
    "--workers",
    "-w",
    type=int,
    help="Set the upperbound for the allowed number of worker threads to spawn when doing parallel tasks. Default: Available software cores.",
)
@click.option(
    "--graph_name",
    "-n",
    default="G",
    show_default=True,
    type=str,
    help="The graph name to initialise in the dotstop file.",
)
@click.option(
    "--needs",
    is_flag=True,
    help="Operate on the needs graph.",
)
@click.pass_context
@cli_utils.abort_click_on(
    FileNotFoundError, FileExistsError, ItemError, GraphStructureError, VersionError
)
def main(
    ctx: click.Context,
    dot: bool,
    verbose: bool,
    init: bool,
    workers: int,
    needs: bool,
    graph_name: str,
) -> None:
    """
    Manipulate, analyze and present the contents of a Trustable Acyclic Graph.\f

    Args:
        ctx (click.Context): Context to append and pass to subcommands
        dot (bool): Build graph from `.dotstop.dot`
        verbose (bool): Set logging level to `DEBUG`
        init(bool): Create an empty dot database
        workers (int): Set the upperbound for spawning worker threads
        graph_name (str): The name of the graph when initialising a new dotstop file.
        needs (bool): Whether to operate on needs graph instead of main graph.
    """
    if ctx.invoked_subcommand is None and "--help" in sys.argv:
        click.echo(ctx.get_help())
        ctx.exit()

    if verbose:
        logger.setLevel(logging.DEBUG)

    workdir = utils.get_workdir()

    # ensure relative paths are resolved correctly relative to the workdir
    os.chdir(workdir)

    ctx.ensure_object(dict)
    dotstop_file = (
        utils.NEEDS_DEFAULT_FILENAME if needs else utils.DOTSTOP_DEFAULT_FILENAME
    )
    ctx.obj["needs"] = needs
    ctx.obj["dotstop_file"] = workdir / dotstop_file
    if init:
        # Temporary check, required until doorstop backend is deprecated.
        if dot:
            utils.make_dotfile(ctx.obj["dotstop_file"], graph_name)
        else:
            logger.warning("Cannot create dot database when using doorstop backend.")

    if dot:
        # passthrough ignore file if it exists.
        trustable_ignore: Path | None = (
            workdir / IGNORE_FILE if (workdir / IGNORE_FILE).exists() else None
        )

        ctx.obj["graph"] = build_trustable_graph(
            graph_source=ctx.obj["dotstop_file"],
            items_source=workdir,
            trustable_ignore=trustable_ignore,
        )

    else:
        logger.warning(
            "Deprecation of support for the doorstop backend is planned. Consider migrating to avoid compatibility problems with later releases."
        )
        ctx.obj["graph"] = build_trustable_graph(doorstop_source=doorstop.build())

    ctx.obj["artifact"] = Artifact()
    ctx.obj["workers"] = workers


@click.command(name="publish")
@click.option(
    "--name",
    "-n",
    default="Software",
    show_default=True,
    type=str,
    help="Project name.",
)
@click.option(
    "--all-bodies/--normative-bodies",
    "-a",
    default=False,
    show_default=True,
    type=bool,
    help="Include text of non-normative items.",
)
@click.option(
    "--figures",
    "-f",
    is_flag=True,
    type=bool,
    help="Include graphs in reports (requires configured data store)",
)
@click.option(
    "--output-dir",
    "-o",
    default="docs/doorstop",
    show_default=True,
    type=Path,
    help="Output directory for reports.",
)
@validate_option
@dump_option
@click.pass_context
@cli_utils.abort_click_on(ItemError, ReferenceError, PluginError, DataModelError)
def _publish(
    ctx: click.Context,
    name: str,
    all_bodies: bool,
    figures: bool,
    output_dir: Path,
    validate: bool,
    dump: Path | None = None,
) -> None:
    """
    Report the status and scores of items as markdown.

    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        name (str): Software project name.
        all_bodies (bool): Include bodies of non-normative records.
        output_dir (Path): Output directory.
        validate (str): Run automated validators.
        dump (Path): Output file path for the Trustable Scores file
    """
    scores = trudag.score.score(ctx.obj["graph"], validate, dump)
    trudag.publish.publish(
        ctx.obj["graph"],
        name,
        all_bodies,
        output_dir,
        validate,
        scores,
        figures,
    )


@click.command(name="plot")
@click.option(
    "--output-file-path",
    "-o",
    default="./graph.svg",
    show_default=True,
    type=Path,
    help="file path for the output graph.",
)
@click.option(
    "--line-length",
    "-l",
    default=32,
    show_default=True,
    type=int,
    help="Soft limit on characters-per-line for plotted items.",
)
@click.option(
    "--url",
    "-u",
    default="",
    type=str,
    help="If specified, items have tooltip: <TEXT>/<DOC>.html#<ITEM>",
)
# Doorstop does not allow commas in UIDs, so this CLI interface supports all possible Doorstop Item UIDs.
@click.option(
    "--same-rank",
    "-s",
    default=[],
    type=str,
    multiple=True,
    help="Fix items on the same vertical rank. Provide as a comma-separated list of item names.",
)
# Doorstop does not allow commas in UIDs, so this CLI interface supports all possible Doorstop Item UIDs.
@click.option(
    "--invis-deps",
    "-i",
    default=[],
    type=(str, str),
    multiple=True,
    help="Add invisible links between items. "
    "Links are temporary and used only for visualization. "
    "Provide as pairs of item names separated by a space. ",
)
@click.option(
    "--pick",
    default=[],
    type=(str, str),
    multiple=True,
    callback=cli_utils.validate_pick_levels,
    help="Picks a node and its parents / children recursively to specified levels. "
    "You must specify the node, and optionally the levels of parents and children to be retained. "
    "The levels of parents / children is formatted as `parents:children`, "
    "for example, the argument `1:2` will pick 1 level of the node's parents, and 2 levels of the children. "
    "You may skip a value to pick all levels recursively, for example: `:1` will pick all levels of parents, "
    "and one level of the children. "
    "You may specify `0:0` to only select the picked node. "
    "This argument can be used multiple times to pick multiple nodes. "
    "You may use this argument together with --orphan-nodes to pick specified nodes and orphan-nodes. ",
)
@click.option(
    "--orphan-nodes",
    type=bool,
    is_flag=True,
    help="Retain nodes that aren't linked with anything else. "
    "You may use this argument together with --pick to retain orphan-nodes and picked nodes. ",
)
@click.pass_context
@cli_utils.abort_click_on(GraphActionError, ItemError)
def _plot(
    ctx: click.Context,
    line_length: int,
    same_rank: str,
    output_file_path: Path,
    url: str,
    invis_deps: tuple[str, str],
    pick: list[tuple[str, int | None, int | None]],
    orphan_nodes: bool,
) -> None:
    """
    Produce a graphic of items and their links.

    All graphics are rendered from dot using graphviz.\f

    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        line_length (int): Soft CPL limit for plotted items
        same_rank (str): Comma-separated string of items to place on same vertical rank.
        output_file_path (Path): output file path for rendered image (default is graph.svg).
        url (str): Tooltip.
        invis_deps (tuple[str, str]): Invisible links used to manipulate item placement in rendered image.
        pick: (list[tuple[str, int | None, int | None]]): Picks nodes to be retained in the graph, specified by item name and levels of parent / child to be picked.
        orphan_nodes (bool): Only keep nodes that isn't linked with anything else.
    """
    # Parse tuples of document prefixes and item identifiers.
    trudag.plot.plot(
        ctx.obj["graph"],
        line_length,
        cli_utils.parse_ranks(same_rank),
        invis_deps,
        pick,
        orphan_nodes,
        output_file_path=output_file_path,
        base_url=url,
    )


@click.group(name="manage", help="Manage the status of items and their links.")
@click.pass_context
@cli_utils.abort_click_on(VersionError)
def manage(ctx: click.Context) -> None:
    if ctx.invoked_subcommand != "format":
        cli_utils.validate_trudag_version(ctx.obj["dotstop_file"])
    ctx.ensure_object(dict)


@manage.command(name="show-link")
@click.argument("parent", type=str)
@click.argument("child", type=str)
@click.pass_context
@cli_utils.abort_click_on(GraphActionError, ItemError)
def _show_link(ctx: click.Context, parent: str, child: str) -> None:
    """
    Show status of the link from PARENT to CHILD.\f

    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        parent (str): Parent item name
        child (str): Child item name
    """
    status = str(ctx.obj["graph"].get_link_status(parent, child))
    click.echo(parent + " -> " + child + " => " + status)


@manage.command(name="set-link")
@click.argument("parent", type=str, nargs=1)
@click.argument("child", type=str, nargs=1)
@click.option(
    "--status",
    "-s",
    default="LINKED",
    type=str,
    help="Set status as LINKED, UNLINKED or SUSPECT.",
)
@click.pass_context
@cli_utils.abort_click_on(GraphActionError, ItemError)
def _set_link(ctx: click.Context, parent: str, child: str, status: str):
    """
    Set status of the link from PARENT to CHILD as LINKED.\f

    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        parent (str): Parent item name
        child (str): Child item name
        status (str): A valid `LinkStatus` string, valid options are SUSPECT or LINKED.
    """

    try:
        status_enum = LinkStatus(status.upper())
    except ValueError as value_error:
        err_msg = (
            f"Cannot set link to invalid status {status}. Options are SUSPECT, LINKED."
        )
        raise GraphActionError(err_msg) from value_error
    ctx.obj["graph"].set_link_status(parent, child, status_enum)
    ctx.obj["graph"].to_file(ctx.obj["dotstop_file"])


@manage.command(name="set-item")
@click.argument("items", nargs=-1)
@click.option(
    "--links",
    type=bool,
    is_flag=True,
    show_default=False,
    help="Set status of the links from this item(s) to other valid items as LINKED.",
)
@click.option(
    "--unreviewed",
    type=bool,
    is_flag=True,
    default=True,
    show_default=False,
    help="Set the item to Unreviewed",
)
@click.pass_context
@cli_utils.abort_click_on(GraphActionError, ItemError)
def _set_item(
    ctx: click.Context, items: tuple[str, ...], links: bool, unreviewed: bool
):
    """
    Set item review status to True.\f

    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        items (tuple[str, ...]): Item(s) given for setting the review status to `True`.
    """
    for item in items:
        ctx.obj["graph"].set_review_status(item, status=unreviewed)
        if links:
            trudag.manage.set_all_link_status(
                ctx.obj["graph"],
                item,
                LinkStatus.LINKED if unreviewed else LinkStatus.SUSPECT,
            )
    ctx.obj["graph"].to_file(ctx.obj["dotstop_file"])


@manage.command(name="show-item")
@click.argument("items", nargs=-1)
@click.option(
    "--statement",
    type=bool,
    is_flag=True,
    show_default=True,
    help="Display item statement.",
)
@click.pass_context
@cli_utils.abort_click_on(GraphActionError, ItemError)
def _show_item(ctx, items: tuple[str, ...], statement: bool):
    """
    Show items current review status.\f

    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        item (tuple[str, ...]): Item(s) to be described.
        statement (bool): Adds statement information in the output
    """

    for item in items:
        output = trudag.manage.describe_item(ctx.obj["graph"], item, statement)
        click.echo(utils.OUTPUT_SEPARATOR)
        click.echo(output)
        click.echo(utils.OUTPUT_SEPARATOR)


@manage.command(name="create-link")
@click.argument("parent", nargs=1)
@click.argument("child", nargs=1)
@click.pass_context
@cli_utils.abort_click_on(GraphActionError, ItemError)
def _create_link(ctx: click.Context, parent: str, child: str) -> None:
    """
    Create a link from PARENT to CHILD.

    The new link will have status LINKED.\f

    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        parent (str): Parent item name
        child (str): Child item name
    """
    ctx.obj["graph"].set_link_status(parent, child, LinkStatus.LINKED)
    ctx.obj["graph"].to_file(ctx.obj["dotstop_file"])


@manage.command(name="create-item")
@click.option(
    "--parent",
    "-p",
    type=str,
    default="",
    help="Set item TEXT as parent.",
)
@click.argument("prefix", nargs=1)
@click.argument("id", nargs=1)
@click.argument("path", nargs=1)
@click.pass_context
@cli_utils.abort_click_on(GraphActionError, FileExistsError)
def _create_item(ctx, path: str, prefix: str, id: str, parent: str) -> None:
    """
    Create a new item in PATH named PREFIX-ID.

    The new item will be reviewed and any new links will have status LINKED.
    Item files are intended for human editing and dtag intentionally provides no options for modifying them from the CLI.\f

    Creates a Markdown file and populate it with all the required attributes.
    The UID of an item is defined by its filename without the extension. An UID
    consists of two parts, the prefix and a number or name

    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        path (str): Path to a directory for item files
        prefix (str): Part of the item name preceeding the last `-` character.
        id (str): Part of the item name following the last `-` character.
        parent (str): Name of a parent item (default: None)

    Returns: `None`
    """
    trudag.manage.create_new_item(
        prefix.strip(),
        Path(path),
        parent,
        id.strip(),
        ctx.obj["dotstop_file"],
        ctx.obj["graph"],
    )


@manage.command(name="remove-link")
@click.argument("parent", nargs=1)
@click.argument("child", nargs=1)
@click.pass_context
@cli_utils.abort_click_on(GraphActionError)
def _remove_link(ctx: click.Context, parent: str, child: str) -> None:
    """
    Remove the link from PARENT to CHILD.

    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        parent (str): Parent item name
        child (str): Child item name
    """
    ctx.obj["graph"].set_link_status(parent, child, LinkStatus.UNLINKED)
    ctx.obj["graph"].to_file(ctx.obj["dotstop_file"])


@manage.command(name="remove-item")
@click.argument("items", nargs=-1)
@click.pass_context
@cli_utils.abort_click_on(GraphActionError, FileExistsError)
def _remove_item(ctx, items: tuple[str, ...]) -> None:
    """
    Remove the item named `name` and all links to it.

    The Markdown file containing the item's definition will not be removed.\f

    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        items (tuple[str, ...]): Name of the item(s) to be removed.
    """
    for item in items:
        ctx.obj["graph"].remove_item(item)
    ctx.obj["graph"].to_file(ctx.obj["dotstop_file"])


@manage.command(
    name="format",
    short_help="Reformat the dotfile to specifications of latest trudag version.",
)
@click.pass_context
def format(ctx: click.Context) -> None:
    ctx.obj["graph"].to_file(ctx.obj["dotstop_file"])


@manage.command(name="lint", short_help="Check the graph for issues.")
@fail_on_error_option
@click.option(
    "--diff",
    type=str,
    help="DEPRECATED: --diff option can now be found at manage diff lint.",
)
@click.option(
    "--dump",
    type=Path,
    help="Dumps the result into a specified path. Extensions allowed: `.json`",
)
@click.pass_context
@cli_utils.abort_click_on(ItemError, GitError, ValueError)
def _lint(
    ctx: click.Context, fail_on_error: bool, diff: str, dump: Path | None
) -> None:
    """
    Log all issues with the Graph.\f

    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        fail_on_error: bool, fails lint command if there's an error during linting.
        diff (str): DEPRECATED option diff option can now be found at manage diff lint (_diff_lint).
        dump (Path | None): Dumps the result into a specified path. Extension determines the format of the dump.
            - Allowed extensions: `.json`

    """
    if diff:
        ctx.fail(
            "--diff option is deprecated for manage lint, use trudag manage diff lint --git-rev BRANCH for same functionality"
        )

    exit_code = trudag.manage.lint(ctx.obj["graph"], dump, ctx.obj["workers"])

    if fail_on_error:
        ctx.exit(exit_code)


@manage.group(
    name="diff",
    help="Group of commands showing differences between trudag artifacts or git revisions.",
)
@click.pass_context
@cli_utils.abort_click_on(VersionError, TypeError, GitError)
def diff(ctx: click.Context) -> None:
    ctx.ensure_object(dict)


@diff.command(
    name="lint",
    short_help="Log differences in lint warnings between either reports or git revisions.",
)
@fail_on_error_option
@click.option(
    "--git-rev",
    type=str,
    help="Git revision to compare current graph with for lint warnings",
)
@click.option(
    "--reports",
    type=(Path, Path),
    help="Lint reports to compare to log lint warning differences",
)
@click.pass_context
@cli_utils.abort_click_on(TypeError, GitError)
def _diff_lint(
    ctx: click.Context,
    fail_on_error: bool,
    git_rev: str,
    reports: tuple[Path, Path],
) -> None:
    """
    Compare lint warnings either between two reports or against a Git revision.

    Args:
        ctx (click.Context): Command context.
        fail_on_error (bool): Whether to exit with an error code if differences are found.
        git_rev (str): Git revision to compare current graph's lint warnings against.
        reports (tuple[Path, Path]): Tuple of two lint report file paths to compare.
    """

    if not git_rev and not reports:
        ctx.fail(
            "Must run diff lint command with one of the following options: --git-rev or --reports"
        )

    if git_rev:
        exit_code = trudag.manage.lint_diff(
            ctx.obj["graph"], git_rev, ctx.obj["workers"]
        )

    if reports:
        exit_code = trudag.manage.diff_lint_report(reports[0], reports[1])

    if fail_on_error:
        ctx.exit(exit_code)


@diff.command(
    name="graph", short_help="Log differences in graph between git revisions."
)
@fail_on_error_option
@click.option(
    "--git-rev",
    type=str,
    help="Git revision to compare current graph with",
)
@click.pass_context
@cli_utils.abort_click_on(TypeError, GitError)
def _diff_graph(
    ctx: click.Context,
    fail_on_error: bool,
    git_rev: str,
) -> None:
    """
    Compare the current graph content to a Git revision's graph.

    Args:
        ctx (click.Context): Command context.
        fail_on_error (bool): Whether to exit with an error code if differences are found.
        git_rev (str): Git revision to compare the current graph against.
    """

    if not git_rev:
        ctx.fail("Must define git revision to compare to using --git-rev option.")

    if git_rev:
        exit_code = trudag.manage.diff_graph_git(ctx.obj["graph"], git_rev)

    if fail_on_error:
        ctx.exit(exit_code)


@manage.command(name="migrate")
@click.pass_context
def _migrate(ctx: click.Context) -> None:
    """
    Convert a doorstop database to dot.\f

    Args:
        ctx (click.Context): Command context, including output path.
    """
    build_trustable_graph(doorstop_source=doorstop.build()).to_file(
        ctx.obj["dotstop_file"]
    )


@click.command(
    name="score",
    short_help="Compute the Trustable Score of every item.",
)
@validate_option
@dump_option
@click.pass_context
@cli_utils.abort_click_on(DotstopError, PluginError)
def _score(ctx: click.Context, validate: bool, dump: Path | None = None) -> None:
    """
    Recursively compute the Trustable score of all items in the Graph.

    Scores are computed upwards from the Evidence items, with items that are not
    scored assumed to have score zero. Suspect links and unreviewed items are
    ignored when computing scores.\f


    Args:
        ctx (click.Context): Command context, including a `dotstop.Graph`.
        validate (bool): Run automated validators.
        dump (Path): Output file path for the Trustable Scores file
    """
    all_scores = trudag.score.score(ctx.obj["graph"], validate, dump)
    for key, value in all_scores.items():
        click.echo(f"{key} = {value}")


@click.command(
    name="export",
    short_help="Export the resolved graph and needs items as an artifact.",
)
@artifact_option
@click.option(
    "--project-name",
    "-P",
    type=str,
    required=True,
    help="The name of the project that is to be exported.",
)
@click.pass_context
@cli_utils.abort_click_on(ArtifactError, SchemaError, YAMLError)
def _export(ctx: click.Context, project_name: str, artifact: Path) -> None:
    # Make sure we don't have linting problems before we start exporting
    trudag.manage.lint(ctx.obj["graph"], None, ctx.obj["workers"])
    if ctx.obj["needs"]:
        click.BadOptionUsage(
            message="Cannot use needs option with export command",
            option_name="Error",
        )
    with ctx.obj["artifact"]:
        ctx.obj["artifact"].export_to(ctx.obj["graph"], project_name, artifact)


@click.command(name="import", short_help="Import artifact and extract the needs items.")
@artifact_option
@click.option(
    "--graph-root",
    "-R",
    type=str,
    required=False,
    default="TRUSTABLE-SOFTWARE",
    show_default=True,
    help="The root node to be imported from the artifact.",
)
@click.option(
    "--needs-dir",
    "-d",
    required=True,
    type=click.Path(path_type=Path, file_okay=False, dir_okay=True),
    help="Path for the needs items to be extracted to.",
)
@click.option(
    "--namespace",
    "-n",
    required=True,
    type=str,
    help="Namespace to be set for the graphs inside the artifact.",
)
@click.pass_context
@cli_utils.abort_click_on(ArtifactError, SchemaError, YAMLError)
def _import(
    ctx: click.Context,
    artifact: Path,
    graph_root: str,
    needs_dir: Path,
    namespace: str,
) -> None:
    with ctx.obj["artifact"]:
        ctx.obj["artifact"].import_from(
            artifact,
            ctx.obj["graph"],
            ctx.obj["dotstop_file"],
            namespace,
            needs_dir,
            graph_root,
        )


main.add_command(_publish)
main.add_command(_plot)
main.add_command(_score)
main.add_command(manage)
main.add_command(_export)
main.add_command(_import)

if __name__ == "__main__":
    main()
