from git import Repo
import pytest
import traceback
import frontends.cli as cli
from trudag.utils import DOTSTOP_DEFAULT_FILENAME
from pathlib import Path
import click.testing
from click.testing import Result


@pytest.fixture
def exec_command_in_project(
    project_files, command, tmp_path, monkeypatch, caplog
) -> tuple[Path, Result, list[tuple[str, int, str]]]:
    # we create a sub-directory for the test for each of the project files
    # this can be used in the test cases to execute actions on specific project files.
    tmp_path = tmp_path.joinpath(str(id(project_files)))
    tmp_path.mkdir()
    # create the files in the project
    if references := project_files.get("references"):
        for ref_name, ref_text in references.items():
            Path(tmp_path / Path(ref_name)).write_text(ref_text)
    dot_path = tmp_path / DOTSTOP_DEFAULT_FILENAME
    dot_path.write_text(project_files["dot_source"])
    for item_name, item_source in project_files["items_source"].items():
        item_path = tmp_path / Path(item_name + ".md")
        item_path.write_text(item_source)

    # run the given commands
    # for the git repository info required by some tests, we need a revision
    monkeypatch.chdir(tmp_path)
    monkeypatch.setenv("GIT_AUTHOR_EMAIL", "test")
    monkeypatch.setenv("GIT_AUTHOR_NAME", "test")
    monkeypatch.setenv("GIT_COMMITTER_EMAIL", "test")
    monkeypatch.setenv("GIT_COMMITTER_NAME", "test")
    repo = Repo.init()
    repo.git.add(".")
    repo.git.commit(m="test commit", no_gpg_sign=True)
    runner = click.testing.CliRunner()
    result = runner.invoke(cli.main, [*command])
    if result.exception:
        traceback.print_exception(*result.exc_info)
    return (tmp_path, result, caplog.record_tuples)
